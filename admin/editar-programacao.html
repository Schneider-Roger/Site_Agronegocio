<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Editar Programação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/programacao-admin.css">
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="logo-container">
        <img src="assets/img/Modo_de_isolamento.png" alt="Logo da Feira">
      </div>
      <nav>
        <a href="dashboard.html"> Painel</a>
        <a href="editar-home.html"> Editar Home</a>
        <a href="editar-programacao.html" class="active"> Programação</a>
        <a href="gerenciar-galeria.html"> Galeria</a>
        <a href="expositores.html"> Expositores</a>
        <a href="mensagens.html"> Mensagens</a>
      </nav>
      <div class="logout-footer">
        <a href="/logout" class="logout-btn">Desconectar</a>
      </div>
    </aside>
    <main class="main-content">
      <h1>Editar Programação da Feira</h1>
      <div class="form-box">
        <form id="form-editar-programacao">
          <div class="form-section">
            <h2 style="margin-top:32px;color:#005523;font-size:22px;font-weight:700;"></h2>
          </div>
          <div class="programacao-admin-flex">
            <div class="form-section programacao-col">
              <h3 style="color:#005523;font-size:18px;font-weight:600;">Feira Online</h3>
              <div id="programacao-admin-online" class="programacao-admin-lista"></div>
              <div class="programacao-admin-botoes-add">
                <button type="button" id="add-dia-online" class="btn btn-outline">Adicionar Dia Online</button>
              </div>
            </div>
            <div class="form-section programacao-col">
              <h3 style="color:#994C11;font-size:18px;font-weight:600;">Feira Presencial</h3>
              <div id="programacao-admin-presencial" class="programacao-admin-lista"></div>
              <div class="programacao-admin-botoes-add">
                <button type="button" id="add-dia-presencial" class="btn btn-outline">Adicionar Dia Presencial</button>
              </div>
            </div>
          </div>
          <button type="submit">Salvar Programação</button>
        </form>
      </div>
    </main>
  </div>
  <!-- Templates para dia e evento -->
  <template id="tpl-dia-programacao">
    <div class="dia-programacao-admin">
      <input type="text" class="input-dia-data" placeholder="Data (ex: 10/08/2025)">
      <button type="button" class="remover-dia-btn">Remover Dia</button>
      <div class="eventos-dia-lista"></div>
      <button type="button" class="adicionar-evento-btn btn btn-outline" style="margin-top:8px;">Adicionar Evento</button>
    </div>
  </template>
  <template id="tpl-evento-programacao">
    <div class="evento-programacao-admin">
      <div class="evento-inputs-row">
        <input type="text" class="input-evento-hora" placeholder="Hora (ex: 14:00)">
        <input type="text" class="input-evento-titulo" placeholder="Nome do Evento">
      </div>
      <button type="button" class="remover-evento-btn" style="margin-top:10px;width:100%;">Remover</button>
    </div>
  </template>
  <script>
    // Estado local da programação
    let programacao = { online: [], presencial: [] };
    // Carregar programação existente do backend
    fetch('http://localhost:3000/api/home')
      .then(res => res.json())
      .then(data => {
        if (data.programacao_online) programacao.online = data.programacao_online;
        if (data.programacao_presencial) programacao.presencial = data.programacao_presencial;
        renderProgramacao('online');
        renderProgramacao('presencial');
      });
    // Adicionar dia
    document.getElementById('add-dia-online').onclick = () => { addDia('online'); };
    document.getElementById('add-dia-presencial').onclick = () => { addDia('presencial'); };
    function addDia(tipo) {
      programacao[tipo].push({ data: '', eventos: [] });
      renderProgramacao(tipo);
    }
    // Função utilitária para formatar data no formato "23 de janeiro" e retornar o dia da semana
    function formatarDataComDiaSemana(dataStr) {
      if (!dataStr) return '';
      // Espera data no formato dd/mm/yyyy
      const partes = dataStr.split('/');
      if (partes.length !== 3) return dataStr;
      const [dia, mes, ano] = partes;
      const meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      const data = new Date(`${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`);
      if (isNaN(data.getTime())) return dataStr;
      const diaSemana = ['Domingo','Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado'][data.getDay()];
      return { diaSemana, diaMes: `${parseInt(dia)} de ${meses[data.getMonth()]}` };
    }
    // Renderizar programação
    function renderProgramacao(tipo) {
      const lista = document.getElementById('programacao-admin-' + tipo);
      lista.innerHTML = '';
      if (!programacao[tipo] || programacao[tipo].length === 0) {
        lista.innerHTML = `<div style='color:#888;text-align:center;padding:24px;'>Nenhum dia cadastrado.</div>`;
        return;
      }
      programacao[tipo].forEach((dia, diaIdx) => {
        const tpl = document.getElementById('tpl-dia-programacao').content.cloneNode(true);
        const inputData = tpl.querySelector('.input-dia-data');
        inputData.value = dia.data;
        inputData.oninput = e => { programacao[tipo][diaIdx].data = e.target.value; };
        // Exibe dia da semana e dia do mês formatado
        const dataFormatada = formatarDataComDiaSemana(dia.data);
        if (dataFormatada && dataFormatada.diaSemana && dataFormatada.diaMes) {
          const infoData = document.createElement('div');
          infoData.className = 'info-dia-formatada';
          infoData.innerHTML = `
            <div style='font-weight:bold;color:#994C11;font-size:1.12em;margin-bottom:2px;'>${dataFormatada.diaSemana}</div>
            <div style='color:#005523;font-size:1.05em;'>${dataFormatada.diaMes}</div>
          `;
          inputData.parentNode.insertBefore(infoData, inputData.nextSibling);
        }
        // Remover dia
        tpl.querySelector('.remover-dia-btn').onclick = () => {
          if (confirm('Remover este dia e todos os eventos?')) {
            programacao[tipo].splice(diaIdx, 1);
            renderProgramacao(tipo);
          }
        };
        // Eventos
        const eventosLista = tpl.querySelector('.eventos-dia-lista');
        if (!dia.eventos) dia.eventos = [];
        if (dia.eventos.length === 0) {
          const vazio = document.createElement('div');
          vazio.style.color = '#aaa';
          vazio.style.textAlign = 'center';
          vazio.style.margin = '8px 0';
          vazio.textContent = 'Nenhum evento cadastrado.';
          eventosLista.appendChild(vazio);
        }
        dia.eventos.forEach((ev, evIdx) => {
          const tplEv = document.getElementById('tpl-evento-programacao').content.cloneNode(true);
          tplEv.querySelector('.input-evento-hora').value = ev.hora || '';
          tplEv.querySelector('.input-evento-hora').oninput = e => { programacao[tipo][diaIdx].eventos[evIdx].hora = e.target.value; };
          tplEv.querySelector('.input-evento-titulo').value = ev.titulo || '';
          tplEv.querySelector('.input-evento-titulo').oninput = e => { programacao[tipo][diaIdx].eventos[evIdx].titulo = e.target.value; };
          tplEv.querySelector('.remover-evento-btn').onclick = () => {
            programacao[tipo][diaIdx].eventos.splice(evIdx, 1);
            renderProgramacao(tipo);
          };
          eventosLista.appendChild(tplEv);
        });
        // Adicionar evento
        tpl.querySelector('.adicionar-evento-btn').onclick = () => {
          if (!dia.eventos) dia.eventos = [];
          programacao[tipo][diaIdx].eventos.push({ hora: '', titulo: '' });
          renderProgramacao(tipo);
        };
        lista.appendChild(tpl);
      });
    }
    // SUBMIT
    document.getElementById('form-editar-programacao').addEventListener('submit', function(e) {
      e.preventDefault();
      // Validação básica da programação
      for (const tipo of ['online','presencial']) {
        for (const dia of programacao[tipo]) {
          if (!dia.data.trim()) {
            alert('Preencha a data de todos os dias da programação.');
            return;
          }
          for (const ev of dia.eventos) {
            if (!ev.hora.trim() || !ev.titulo.trim()) {
              alert('Preencha horário e título de todos os eventos.');
              return;
            }
          }
        }
      }
      // Remove campos ocultos antigos
      document.querySelectorAll('.input-programacao-json').forEach(el => el.remove());
      // Cria campos ocultos para programação
      ['online','presencial'].forEach(tipo => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'programacao_' + tipo;
        input.className = 'input-programacao-json';
        input.value = JSON.stringify(programacao[tipo]);
        this.appendChild(input);
      });
      // Envia o formulário
      const form = e.target;
      const formData = new FormData(form);
      fetch('http://localhost:3000/api/home', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        alert('Programação salva com sucesso!');
        if (data.data.programacao_online) programacao.online = data.data.programacao_online;
        if (data.data.programacao_presencial) programacao.presencial = data.data.programacao_presencial;
        renderProgramacao('online');
        renderProgramacao('presencial');
      })
      .catch(() => alert('Erro ao salvar programação!'));
    });
  </script>
</body>
</html>
